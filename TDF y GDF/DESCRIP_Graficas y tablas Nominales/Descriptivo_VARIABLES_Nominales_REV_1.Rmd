---
title: "Variables_Nominales_Descriptivo"
author: "Grupo 4"
date: "2025-07-28"
output: html_document
---


## Codigo Nominales

```{r cars}
#-------------------------------------------------------
# CARGA DEL DATASET VARIABLES NOMINALES
#-------------------------------------------------------

datos <- read.csv("C:/Users/User/OneDrive/Documentos/estadistica/Electric and Alternative Fuel Charging Stations.csv",
                  header = TRUE, sep = ",", dec = ",")

# Ver estructura del dataset
str(datos)

# Mostrar nombres de las columnas
colnames(datos)

# BLOQUE DE LIBRERÍAS
#-------------------------------------------------------
library(DT)           # Tablas interactivas
library(dplyr)        # Manipulación de datos
library(ggplot2)      # Gráficos
library(htmltools)    # Para captions en datatable
library(htmlwidgets)  # Necesario para JS()
library(scales)       # Para escalas (por ejemplo, percentajes)

1
#-------------------------------------------------------------------------------
# VARIABLE COUNTRY


#--------------- OBTENER VALORES-------------------#

# Obtener valores únicos no nulos de Country
country_values <- unique(na.omit(datos$Country))

# Clasificar valores válidos y sospechosos usando un solo patrón lógico
pattern_validos <- grepl("^[A-Za-z ]+$", country_values)
valores_validos <- country_values[pattern_validos]
valores_sospechosos <- country_values[!pattern_validos]


#------------- FUNCIONES AUXILIARES --------------#

# Función para mostrar listas con encabezado
mostrar_lista <- function(nombre, valores) {
  cat(paste0("\n", nombre, ":\n"))
  print(valores)
}

# Función para estilos comunes del datatable
estilos_header <- JS(
  "function(settings, json) {",
  "$(this.api().table().header()).css({",
  "'background-color': 'darkblue',",
  "'color': 'white',",
  "'font-weight': 'bold',",
  "'font-family': 'Segoe UI'",
  "});",
  "}"
)

estilos_filas_moda <- JS(
  "function(row, data, index) {",
  "$(row).css('font-family', 'Segoe UI');",
  "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
  "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
  "}"
)

#----------------- RESULTADOS EXPLORATORIOS -----------------------#

# Mostrar conteo de cada grupo
cat("Cantidad de valores válidos (solo letras): ", length(valores_validos), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos), "\n")

# Mostrar los valores encontrados
mostrar_lista("Valores válidos", valores_validos)
mostrar_lista("Valores sospechosos", valores_sospechosos)

#--------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE COUNTRY -----------#

# Crear tabla de frecuencia para los valores válidos
tabla_validos <- table(datos$Country[datos$Country %in% valores_validos])

# Convertir a data.frame ordenado de mayor a menor frecuencia
tabla_validos_df <- as.data.frame(tabla_validos)
colnames(tabla_validos_df) <- c("Country", "Frecuencia")
tabla_validos_df <- tabla_validos_df[order(-tabla_validos_df$Frecuencia), ]

# Mostrar la tabla resultante
print(tabla_validos_df)

#------ RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE COUNTRY -----------#

# Calcular la frecuencia máxima (moda)
max_frecuencia <- max(tabla_validos_df$Frecuencia, na.rm = TRUE)

# Filtrar la(s) moda(s)
tabla_moda <- tabla_validos_df[tabla_validos_df$Frecuencia == max_frecuencia, ]

# Imprimir resultado modal
cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA:\n")
print(tabla_moda)

#--------- TABLA INTERACTIVA CON FORMATO PERSONALIZADO -----------------#

datatable(tabla_moda,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = estilos_header,
            rowCallback = estilos_filas_moda,
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Country", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda)"
          )
)

#--- MOSTRAR TABLA INTERACTIVA FRECUENCIA ABSOLUTA PAIS VS ESTACIONES DE CARGA -----#

tabla_completa <- datos %>%
  filter(!is.na(Country)) %>%
  count(Country, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

#-------- AGREGAR FILA DE TOTALES --------------#

total_frecuencia <- sum(tabla_completa$Frecuencia, na.rm = TRUE)
fila_total <- data.frame(Country = "TOTAL", Frecuencia = total_frecuencia)
tabla_con_total <- bind_rows(tabla_completa, fila_total)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA PAÍS VS ESTACIONES DE CARGA --------#

datatable(tabla_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)  
            ),
            initComplete = estilos_header,
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(data[0] === 'CA' || data[0] === 'US') {",
              "$(row).css('background-color', 'white');",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Pais", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 1. Frecuencia por estación de Países"
          )
)

#---------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA POR PAÍS ------------------#

# Crear tabla sin TOTAL y convertir frecuencia a numérico
tabla_frec_paises <- tabla_con_total %>%
  filter(Country != "TOTAL") %>%
  mutate(Frecuencia = as.numeric(Frecuencia))

# Crear gráfico
ggplot(tabla_frec_paises, aes(x = reorder(Country, -Frecuencia), y = Frecuencia, fill = Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  labs(
    title = "Gráfica N° 1.1 Frecuencia Absoluta de Estaciones por País",
    x = "País",
    y = "Frecuencia",
    fill = "Frecuencia"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#---- GRÁFICA CIRCULAR – FRECUENCIA ABSOLUTA CON ETIQUETAS ENMARCADAS --------#

# Preparar datos para la gráfica circular
tabla_graf_pais_abs <- tabla_con_total %>%
  filter(Country != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    porcentaje = Frecuencia / sum(Frecuencia),
    etiqueta = paste0(Country, ": ", Frecuencia),
    color_etiqueta = ifelse(Country == "CA", "skyblue", "darkblue")
  ) %>%
  arrange(desc(Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = c(0, head(ymax, n = -1)),
    pos = (ymax + ymin) / 2
  )

# Crear gráfico circular
ggplot(tabla_graf_pais_abs, aes(ymax = ymax, ymin = ymin, xmax = 2, xmin = 0, fill = Country)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con rectángulo sin relleno
  geom_label(
    aes(x = 2.5, y = pos, label = etiqueta),
    fill = NA,
    color = tabla_graf_pais_abs$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Colores de sectores
  scale_fill_manual(values = c("CA" = "skyblue", "US" = "darkblue")) +
  
  # Leyenda y estilo
  labs(
    title = "Gráfica 1.2 Distribución de la Frecuencia Absoluta por País",
    fill = "Frecuencia Absoluta"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = "right",
    legend.title = element_text(face = "bold", size = 12, family = "Segoe UI"),
    legend.text = element_text(size = 11, family = "Segoe UI")
  )

#-------------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA POR PAÍS --------------#

# Preparar datos: eliminar fila "TOTAL" y calcular frecuencia relativa
tabla_graf_pais_rel <- tabla_con_total %>%
  filter(Country != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),  # Asume que no hay puntos, no se usa gsub
    FrecuenciaRelativa = round(Frecuencia / sum(Frecuencia), 4)
  )

# Crear gráfico
ggplot(tabla_graf_pais_rel, aes(x = reorder(Country, -FrecuenciaRelativa), y = FrecuenciaRelativa, fill = FrecuenciaRelativa)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = scales::percent(FrecuenciaRelativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 1.3 Frecuencia Relativa de Estaciones por País (%)",
    x = "País",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14, family = "Segoe UI"),
    axis.title.x = element_text(size = 14, face = "bold", family = "Segoe UI"),
    axis.title.y = element_text(size = 14, face = "bold", family = "Segoe UI"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13, family = "Segoe UI"),
    axis.text.y = element_text(size = 13, family = "Segoe UI"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold", family = "Segoe UI")
  )

#---------- GRÁFICA CIRCULAR – FRECUENCIA RELATIVA CON ETIQUETAS ENMARCADAS -----------#

# Preparar datos
tabla_graf_rel <- tabla_con_total %>%
  filter(Country != "TOTAL") %>%
  mutate(
    # Convertir a numérico directamente, asumiendo que no hay puntos como separador de miles
    Frecuencia = as.numeric(Frecuencia),
    FrecuenciaRelativa = Frecuencia / sum(Frecuencia),
    etiqueta = paste0(Country, ": ", round(FrecuenciaRelativa * 100, 1), "%"),
    color_etiqueta = ifelse(Country == "CA", "skyblue", "darkblue")
  ) %>%
  arrange(desc(FrecuenciaRelativa)) %>%
  mutate(
    ymax = cumsum(FrecuenciaRelativa),
    ymin = c(0, head(ymax, -1)),
    pos = (ymax + ymin) / 2
  )

# Graficar
ggplot(tabla_graf_rel, aes(ymax = ymax, ymin = ymin, xmax = 2, xmin = 0, fill = Country)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con marco sin fondo
  geom_label(
    aes(x = 2.5, y = pos, label = etiqueta),
    fill = NA,
    color = tabla_graf_rel$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Colores personalizados
  scale_fill_manual(values = c("CA" = "skyblue", "US" = "darkblue")) +
  
  # Título y estilo
  labs(
    title = "Gráfica Nº 1.4 Porcentaje de la Frecuencia Relativa por País",
    fill = "País"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = "right",
    legend.title = element_text(face = "bold", size = 12, family = "Segoe UI"),
    legend.text = element_text(size = 11, family = "Segoe UI")
  )


```
```{r}
#-------------------------------------------------------------------------------
#---------------------- VARIABLE NOMINAL STATE ------------------------------#

#--------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE STATE ---------#

# Obtener valores únicos no nulos de State (de datos originales, sin filtro)
state_values_raw <- unique(na.omit(datos$State))


#-------------- CLASIFICACIÓN DE VALORES DE STATE -------------#

# Clasificar valores válidos: solo letras y espacios
valores_validos_state_raw <- state_values_raw[grepl("^[A-Za-z ]+$", state_values_raw)]

# Clasificar valores sospechosos: contienen números, símbolos u otros caracteres
valores_sospechosos_state_raw <- state_values_raw[!grepl("^[A-Za-z ]+$", state_values_raw)]


#------------------- RESULTADOS EXPLORATORIOS ---------------------#

# Mostrar conteo de cada grupo
cat("Cantidad de valores válidos (solo letras): ", length(valores_validos_state_raw), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_state_raw), "\n")

# Mostrar los valores encontrados
cat("\nValores válidos:\n")
print(valores_validos_state_raw)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_state_raw)


#------------------------ FILTRO STATES ----------------------------#
# Filtrar Estados de EE.UU.
estados_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(State) %>%
  unique() %>%
  na.omit()

# Filtrar Estados de Canadá
estados_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(State) %>%
  unique() %>%
  na.omit()

# Cantidad de estados únicos y valores encontrados
cat("Cantidad de estados únicos en EEUU:", length(estados_eeuu), "\n")
cat("Estados únicos en EEUU:\n")
print(estados_eeuu)

cat("\nCantidad de provincias/estados únicos en Canadá:", length(estados_canada), "\n")
cat("Provincias/estados únicos en Canadá:\n")
print(estados_canada)



#--- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE STATE (US Y CA) ----------------#

# Filtrar solo datos de US y CA
datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(State))

# Obtener valores únicos válidos de State (solo letras y espacios)
state_values_filtrados <- unique(na.omit(datos_filtrados$State))
valores_validos_state_filtrados <- state_values_filtrados[grepl("^[A-Za-z ]+$", state_values_filtrados)]
valores_sospechosos_state_filtrados <- state_values_filtrados[!grepl("^[A-Za-z ]+$", state_values_filtrados)]

# Mostrar resultados
cat("\nCantidad de valores válidos de State:", length(valores_validos_state_filtrados), "\n")
cat("Valores válidos:\n")
print(valores_validos_state_filtrados)

cat("\nCantidad de valores sospechosos de State:", length(valores_sospechosos_state_filtrados), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_state_filtrados)

# Crear tabla de frecuencia solo con valores válidos
tabla_states_validos <- table(datos_filtrados$State[datos_filtrados$State %in% valores_validos_state_filtrados])

# Convertir a data.frame ordenado
tabla_ordenada_state <- as.data.frame(tabla_states_validos)
colnames(tabla_ordenada_state) <- c("State", "Frecuencia")
tabla_ordenada_state <- tabla_ordenada_state[order(-tabla_ordenada_state$Frecuencia), ]

# Mostrar tabla final
print(tabla_ordenada_state)


#--------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE STATE ----------------#

# Calcular la frecuencia máxima (moda)
max_frecuencia_state <- max(tabla_ordenada_state$Frecuencia, na.rm = TRUE)

# Filtrar la(s) moda(s)
tabla_moda_state <- tabla_ordenada_state[tabla_ordenada_state$Frecuencia == max_frecuencia_state, ]

# Imprimir resultado modal
cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (STATE):\n")
print(tabla_moda_state)

#----------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA STATE -------------#

datatable(tabla_moda_state,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Estado", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Estados)"
          )
)

#---------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA STATE -----------------#

tabla_ordenada_state <- datos_filtrados %>%
  count(State, name = "Frecuencia") %>%   # Contar frecuencia
  arrange(desc(Frecuencia))               # Ordenar de mayor a menor


#------------ AGRUPAR POR RANGOS DECILES --------------------------------#

tabla_ordenada_state <- tabla_ordenada_state %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 200    ~ "001 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 500    ~ "301 - 500",
    Frecuencia >= 501   & Frecuencia <= 700    ~ "501 - 700",
    Frecuencia >= 701   & Frecuencia <= 800    ~ "701 - 800",
    Frecuencia >= 801   & Frecuencia <= 1000   ~ "801 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 2000   ~ "1001 - 2000",
    Frecuencia >= 2001  & Frecuencia <= 3000   ~ "2001 - 3000",
    Frecuencia >= 3001  & Frecuencia <= 4000   ~ "3001 - 4000",
    Frecuencia >= 4001  & Frecuencia <= 16200  ~ "4001 - 16200",
    TRUE ~ "Fuera de Rango"
  ))


#---------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL ------------------#

tabla_por_grupo <- tabla_ordenada_state %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 200", "201 - 300", "301 - 500", "501 - 700", "701 - 800",
    "801 - 1000", "1001 - 2000", "2001 - 3000", "3001 - 4000", "4001 - 16200"
  )))


#------------- AGREGAR FILA DE TOTAL GENERAL EN TABLA -------------------#

total_general <- sum(tabla_por_grupo$Total_Frecuencia, na.rm = TRUE)
fila_total <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general)
tabla_por_grupo_con_total <- bind_rows(tabla_por_grupo, fila_total)


#-------------------- MOSTRAR TABLA RESULTANTE -----------------------------#

print(tabla_por_grupo_con_total)


#----------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA ESTADO VS EST. CARGA ------#

library(DT)
library(htmltools)

datatable(tabla_por_grupo_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 2. Frecuencia por Intervalo de las Estaciones de Estados"
          )
)

#---------- TABLA AGRUPADO POR RANGO Y LOS ESTADOS QUE INCLUYEN -----------------#

# Agrupar estados por grupo, concatenar los nombres de los estados con su frecuencia
tabla_estados_por_grupo <- tabla_ordenada_state %>%
  filter(Grupo != "Fuera de Rango") %>%  # Opcional, excluir si quieres
  group_by(Grupo) %>%
  summarise(
    Estados = paste0(State, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 200", "201 - 300", "301 - 500", "501 - 700", "701 - 800",
    "801 - 1000", "1001 - 2000", "2001 - 3000", "3001 - 4000", "4001 - 16200"
  )))

# Mostrar tabla resultante
print(tabla_estados_por_grupo)


#---------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA ESTADO VS EST. CARGA -----------#

library(DT)
library(htmltools)

datatable(tabla_estados_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),
              list(width = '350px', targets = 1),
              list(width = '130px', targets = 2)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Estados (Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 3: Estados agrupados por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA POR ESTADO ----------------#

library(ggplot2)
library(dplyr)

# Renombrar tabla original a un nombre más claro
tabla_frecuencia_estado <- tabla_por_grupo

# Filtrar grupo TOTAL si existe
tabla_frecuencia_estado_filtrada <- tabla_frecuencia_estado %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras por rangos de frecuencia
ggplot(tabla_frecuencia_estado_filtrada, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  labs(
    title = "Gráfica N° 2.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Estados",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = "inside",
    legend.position.inside = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )



#--------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA POR ESTADO --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: filtrar, convertir, calcular porcentaje y posiciones para el gráfico
tabla_frecuencia_estado_filtrada <- tabla_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Orden ascendente para colores

# Reordenar factor Grupo para que los colores sigan el orden ascendente
tabla_frecuencia_estado_filtrada$Grupo <- factor(tabla_frecuencia_estado_filtrada$Grupo, 
                                                 levels = tabla_frecuencia_estado_filtrada$Grupo)

# Calcular posiciones circulares (para el gráfico, orden descendente de frecuencia)
tabla_frecuencia_estado_filtrada <- tabla_frecuencia_estado_filtrada %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Crear paleta de colores de skyblue a darkblue para cada grupo (orden ascendente)
colores_por_grupo <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_frecuencia_estado_filtrada$Grupo))),
  levels(tabla_frecuencia_estado_filtrada$Grupo)
)

# Agregar color para etiquetas según grupo
tabla_frecuencia_estado_filtrada$color_etiqueta <- colores_por_grupo[as.character(tabla_frecuencia_estado_filtrada$Grupo)]

# Gráfico circular
ggplot(tabla_frecuencia_estado_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía para etiquetas
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color acorde al grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_frecuencia_estado_filtrada$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala manual de colores fijos y ordenados
  scale_fill_manual(values = colores_por_grupo) +
  
  # Etiquetas y tema
  labs(
    title = "Gráfica N° 2.2 Distribucion de la Frecuencia Absoluta de Estaciones de Carga por Rango de Estados",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )


#-------------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA POR ESTADO -----------------#

library(ggplot2)
library(dplyr)
library(scales)  # para percent()

tabla_filtrada <- tabla_por_grupo %>%
  filter(Grupo != "TOTAL") %>%                     # Excluir fila TOTAL
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia)  # Asegurar tipo numérico
  ) %>%
  # Calcular frecuencia relativa solo una vez
  mutate(Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia))



ggplot(tabla_filtrada, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = scales::percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 2.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Estados",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )



#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR ESTADO ----------------#

library(ggplot2)
library(dplyr)
library(scales)

# PREPARACIÓN DE DATOS - Filtrado y Cálculo de Frecuencia Relativa

tabla_filtrada <- tabla_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar tabla por Total_Frecuencia ascendente para colores
tabla_filtrada <- tabla_filtrada %>%
  arrange(Total_Frecuencia)

# Reordenar factor Grupo para que los colores sigan el orden ascendente
tabla_filtrada$Grupo <- factor(tabla_filtrada$Grupo, levels = tabla_filtrada$Grupo)

# Calcular posiciones circulares (orden descendente para gráfico)
tabla_filtrada <- tabla_filtrada %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Crear paleta de colores de skyblue a darkblue para cada grupo (orden ascendente)
colores_por_grupo <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_filtrada$Grupo))),
  levels(tabla_filtrada$Grupo)
)

# Agregar color para etiquetas
tabla_filtrada$color_etiqueta <- colores_por_grupo[as.character(tabla_filtrada$Grupo)]



ggplot(tabla_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con porcentaje y color acorde al grupo
  geom_label(
    aes(x = 2.5, y = pos, label = scales::percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_filtrada$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala manual para fill, con colores fijos y ordenados
  scale_fill_manual(values = colores_por_grupo) +
  
  # Estilo general y leyenda
  labs(
    title = "Gráfica N° 2.4 Porcentaje de Frecuencia Relativa de Estaciones de Carga por Rango de Estados",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

```
```{r}

#------------------- VARIABLE NOMINAL: CITY -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE City --------------#

# Copia de respaldo por seguridad
datos$City_original <- datos$City

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$City <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$City)

# Reemplazar múltiples espacios por uno solo
datos$City <- gsub("\\s+", " ", datos$City)

# Eliminar espacios al inicio y fin
datos$City <- trimws(datos$City)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE CITY ----------------#

# Extraer valores únicos no nulos después de limpieza
city_values <- unique(na.omit(datos$City))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_city <- city_values[grepl(pattern_valido, city_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_city <- city_values[!grepl(pattern_valido, city_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE CITY ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_city), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_city), "\n")

cat("\nValores válidos:\n")
print(valores_validos_city)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_city)

#---------------------- FILTRO CIUDADES POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(City) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(City) %>%
  unique() %>%
  na.omit()

cat("Cantidad de ciudades únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Ciudades únicas en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nCantidad de ciudades únicas en Canadá:", length(ciudades_canada), "\n")
cat("Ciudades únicas en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE CITY -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(City))

# Crear tabla de frecuencia con valores válidos
tabla_city_validos <- datos_filtrados %>%
  filter(City %in% valores_validos_city) %>%
  count(City, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de City:", nrow(tabla_city_validos), "\n")
cat("Valores válidos:\n")
print(tabla_city_validos$City)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de City:", length(valores_sospechosos_city), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_city)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE CITY --------------#

max_frecuencia_city <- max(tabla_city_validos$Frecuencia, na.rm = TRUE)
tabla_moda_city <- tabla_city_validos %>% filter(Frecuencia == max_frecuencia_city)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (CITY):\n")
print(tabla_moda_city)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA CITY ------------#

datatable(tabla_moda_city,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Ciudad", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla- Resumen Estadístico por Frecuencia (Moda de Ciudades)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA CITY ----------------------#

tabla_ordenada_city <- tabla_city_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – CITY -----------------------#

tabla_ordenada_city <- tabla_ordenada_city %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – CITY ----------------#

tabla_por_grupo_city <- tabla_ordenada_city %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – CITY ---------------------------#

total_general_city <- sum(tabla_por_grupo_city$Total_Frecuencia, na.rm = TRUE)
fila_total_city <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_city)
tabla_por_grupo_city_con_total <- bind_rows(tabla_por_grupo_city, fila_total_city)

#------------------ MOSTRAR TABLA RESULTANTE – CITY -------------------------------#

print(tabla_por_grupo_city_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA CITY VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_city_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 3. Frecuencia por Intervalo de estaciones de carga de Ciudades"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y CIUDADES ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_city %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(City, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA CIUDAD VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # Ciudades
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Ciudades (Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla: Ciudades agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA POR CIUDAD ---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para City por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Gráfica N° 3.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Ciudades",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA POR CITY --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Gráfica N° 3.2 Distribucion de la Frecuencia Absoluta de Estaciones de Carga por Rango de Ciudades",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA POR CIUDAD -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 3.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Ciudades",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR CITY -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica N° 3.4 Porcentaje de Frecuencia Relativa de Estaciones de Carga por Rango de Estados",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )



```
```{r}

#---------------------- VARIABLE NOMINAL Access.Code ------------------------------#

#--------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Access.Code ---------#

# Obtener valores únicos no nulos de Access.Code (de datos originales, sin filtro)
fuel_type_values_raw <- unique(na.omit(datos$Access.Code))


#-------------- CLASIFICACIÓN DE VALORES DE Access.Code -------------#

# Clasificar valores válidos: todos los valores sin filtrar, incluyendo sospechosos
valores_validos_fuel_type_raw <- fuel_type_values_raw

# Como todos son válidos, no hay valores sospechosos para mostrar
valores_sospechosos_fuel_type_raw <- character(0)


#------------------- RESULTADOS EXPLORATORIOS ---------------------#

# Mostrar conteo de cada grupo
cat("Cantidad de valores válidos (todos los valores, sin filtrar): ", length(valores_validos_fuel_type_raw), "\n")
cat("Cantidad de valores sospechosos (ninguno, ya que se consideran válidos): ", length(valores_sospechosos_fuel_type_raw), "\n")

# Mostrar los valores encontrados
cat("\nValores válidos:\n")
print(valores_validos_fuel_type_raw)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_fuel_type_raw)


#----------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Access.Code ------------#

# Filtrar datos no nulos en Access.Code
datos_fuel_filtrados <- datos %>% filter(!is.na(Access.Code))

# Obtener valores únicos (sin filtrar, incluyendo sospechosos)
fuel_type_values_filtrados <- unique(na.omit(datos_fuel_filtrados$Access.Code))

# Considerar todos los valores como válidos (incluyendo sospechosos)
valores_validos_fuel_type_filtrados <- fuel_type_values_filtrados

# No quedan valores sospechosos excluidos
valores_sospechosos_fuel_type_filtrados <- character(0)

# Mostrar resultados
cat("\nCantidad de valores válidos de Access.Code (incluyendo sospechosos):", length(valores_validos_fuel_type_filtrados), "\n")
cat("Valores válidos:\n")
print(valores_validos_fuel_type_filtrados)

cat("\nCantidad de valores sospechosos de Access.Code:", length(valores_sospechosos_fuel_type_filtrados), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_fuel_type_filtrados)


# Crear tabla de frecuencia solo con valores válidos (todos incluidos)
tabla_fuel_type_validos <- table(datos_fuel_filtrados$Access.Code[datos_fuel_filtrados$Access.Code %in% valores_validos_fuel_type_filtrados])

# Convertir a data.frame ordenado
tabla_ordenada_fuel_type <- as.data.frame(tabla_fuel_type_validos)
colnames(tabla_ordenada_fuel_type) <- c("Access.Code", "Frecuencia")
tabla_ordenada_fuel_type <- tabla_ordenada_fuel_type[order(-tabla_ordenada_fuel_type$Frecuencia), ]

# Mostrar tabla final
print(tabla_ordenada_fuel_type)

#--------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Access.Code ----------------#

# Calcular la frecuencia máxima (moda)
max_frecuencia_fuel_type <- max(tabla_ordenada_fuel_type$Frecuencia, na.rm = TRUE)

# Filtrar la(s) moda(s)
tabla_moda_fuel_type <- tabla_ordenada_fuel_type[tabla_ordenada_fuel_type$Frecuencia == max_frecuencia_fuel_type, ]

# Imprimir resultado modal
cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Access.Code):\n")
print(tabla_moda_fuel_type)

#----------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Access.Code -------------#

datatable(tabla_moda_fuel_type,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Access.Code", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Access.Code)"
          )
)

#------------- AGREGAR FILA DE TOTAL GENERAL EN TABLA Access.Code -------------------#

total_general_fuel_type <- sum(tabla_ordenada_fuel_type$Frecuencia, na.rm = TRUE)
fila_total_fuel_type <- data.frame(Access.Code = "TOTAL", Frecuencia = total_general_fuel_type)
tabla_fuel_type_con_total <- bind_rows(tabla_ordenada_fuel_type, fila_total_fuel_type)


# Mostrar tabla con total
print(tabla_fuel_type_con_total)


#-------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA FUEL TYPE CODE VS EST. CARGA ---------#

library(DT)
library(htmltools)

datatable(tabla_fuel_type_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Access.Code", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 4. Frecuencia de Estaciones de Carga por Código de Acceso (Access.Code)"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA CODE ACCESS ----------------#


library(ggplot2)
library(dplyr)

# Renombrar tabla original a un nombre más claro para Access.Code
tabla_frecuencia_fuel_type <- tabla_fuel_type_con_total

# Filtrar fila TOTAL si existe
tabla_frecuencia_fuel_type_filtrada <- tabla_frecuencia_fuel_type %>% 
  filter(Access.Code != "TOTAL") %>%
  mutate(Frecuencia = as.numeric(Frecuencia))

# Crear gráfico de barras por Access.Code
ggplot(tabla_frecuencia_fuel_type_filtrada, aes(x = reorder(Access.Code, -Frecuencia), y = Frecuencia, fill = Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  labs(
    title = "Gráfica N° 4.1 Frecuencia Absoluta de Estaciones de Carga por Código de Acceso (Access.Code)",
    x = "Tipo de Combustible",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = "inside",
    legend.position.inside = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )


#--------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA CODIGO DE ACCESO--------------#

library(ggplot2)
library(dplyr)
library(scales)
library(ggrepel)  # <-- Añadir esta librería

# Preparar datos (igual que antes)
tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_type %>%
  filter(Access.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    porcentaje = Frecuencia / sum(Frecuencia)
  ) %>%
  arrange(Frecuencia)

tabla_frecuencia_fuel_filtrada$Access.Code <- factor(tabla_frecuencia_fuel_filtrada$Access.Code, 
                                                     levels = tabla_frecuencia_fuel_filtrada$Access.Code)

tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_filtrada %>%
  arrange(desc(Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

colores_por_fuel <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_frecuencia_fuel_filtrada$Access.Code))),
  levels(tabla_frecuencia_fuel_filtrada$Access.Code)
)

tabla_frecuencia_fuel_filtrada$color_etiqueta <- colores_por_fuel[as.character(tabla_frecuencia_fuel_filtrada$Access.Code)]

# Gráfico circular con geom_label_repel para evitar amontonamiento
ggplot(tabla_frecuencia_fuel_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Access.Code
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía para etiquetas (puedes ajustar o eliminar si quieres)
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con repel para evitar superposición
  geom_label_repel(
    aes(x = 2.5, y = pos, label = Frecuencia, color = Access.Code),
    fill = NA,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8,
    show.legend = FALSE,
    nudge_x = 0.3,
    segment.color = "gray30",
    segment.size = 0.6,
    force = 1.5,
    max.overlaps = Inf
  ) +
  
  scale_fill_manual(values = colores_por_fuel) +
  scale_color_manual(values = colores_por_fuel) +  # Color de texto acorde a segmento
  
  labs(
    title = "Gráfica N° 4.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Código de Acceso (Access.Code)",
    fill = "Access.Code"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )


#------------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA ACCESS CODE ----------------#

library(ggplot2)
library(dplyr)

# Renombrar tabla original a un nombre más claro para Access.Code
tabla_frecuencia_fuel_type <- tabla_fuel_type_con_total

# Filtrar fila TOTAL si existe, convertir frecuencia a numérico y calcular frecuencia relativa
tabla_frecuencia_fuel_type_relativa <- tabla_frecuencia_fuel_type %>% 
  filter(Access.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    Frecuencia_Relativa = Frecuencia / sum(Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_frecuencia_fuel_type_relativa, aes(x = reorder(Access.Code, -Frecuencia_Relativa), y = Frecuencia_Relativa, fill = Frecuencia_Relativa)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = scales::percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N°4.3 Frecuencia Relativa de Estaciones de Carga por Código de Acceso (Access.Code) (%)",
    x = "Tipo de Combustible",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )


#--------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA CODIGO DE ACCESO --------------#

library(ggplot2)
library(dplyr)
library(scales)
library(ggrepel)  # Para etiquetas repelentes

# Preparar datos (frecuencia relativa)
tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_type %>%
  filter(Access.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    porcentaje = Frecuencia / sum(Frecuencia)
  ) %>%
  arrange(Frecuencia)

tabla_frecuencia_fuel_filtrada$Access.Code <- factor(
  tabla_frecuencia_fuel_filtrada$Access.Code, 
  levels = tabla_frecuencia_fuel_filtrada$Access.Code
)

tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_filtrada %>%
  arrange(desc(Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

colores_por_fuel <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_frecuencia_fuel_filtrada$Access.Code))),
  levels(tabla_frecuencia_fuel_filtrada$Access.Code)
)

tabla_frecuencia_fuel_filtrada$color_etiqueta <- colores_por_fuel[as.character(tabla_frecuencia_fuel_filtrada$Access.Code)]

# Gráfico circular con etiquetas repelentes que muestran porcentaje
ggplot(tabla_frecuencia_fuel_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Access.Code
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía para etiquetas (ajustables)
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas repelentes con porcentaje
  geom_label_repel(
    aes(x = 2.5, y = pos, label = scales::percent(porcentaje, accuracy = 0.1), color = Access.Code),
    fill = NA,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8,
    show.legend = FALSE,
    nudge_x = 0.3,
    segment.color = "gray30",
    segment.size = 0.6,
    force = 1.5,
    max.overlaps = Inf
  ) +
  
  scale_fill_manual(values = colores_por_fuel) +
  scale_color_manual(values = colores_por_fuel) +  # Color de texto acorde al segmento
  
  labs(
    title = "Grafico Nº 4.4 Porcentaje de la Frecuencia Relativa de Estaciones de Carga por Código de Acceso (Access.Code)",
    fill = "Access.Code"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )


```
```{r}

#---------------------- VARIABLE NOMINAL FUEL.TYPE.CODE ------------------------------#

#--------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE FUEL.TYPE.CODE ---------#

# Obtener valores únicos no nulos de Fuel.Type.Code (de datos originales, sin filtro)
fuel_type_values_raw <- unique(na.omit(datos$Fuel.Type.Code))


#-------------- CLASIFICACIÓN DE VALORES DE FUEL.TYPE.CODE -------------#

# Clasificar valores válidos: todos los valores sin filtrar, incluyendo sospechosos
valores_validos_fuel_type_raw <- fuel_type_values_raw

# Como todos son válidos, no hay valores sospechosos para mostrar
valores_sospechosos_fuel_type_raw <- character(0)


#------------------- RESULTADOS EXPLORATORIOS ---------------------#

# Mostrar conteo de cada grupo
cat("Cantidad de valores válidos (todos los valores, sin filtrar): ", length(valores_validos_fuel_type_raw), "\n")
cat("Cantidad de valores sospechosos (ninguno, ya que se consideran válidos): ", length(valores_sospechosos_fuel_type_raw), "\n")

# Mostrar los valores encontrados
cat("\nValores válidos:\n")
print(valores_validos_fuel_type_raw)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_fuel_type_raw)


#----------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE FUEL.TYPE.CODE ------------#

# Filtrar datos no nulos en Fuel.Type.Code
datos_fuel_filtrados <- datos %>% filter(!is.na(Fuel.Type.Code))

# Obtener valores únicos (sin filtrar, incluyendo sospechosos)
fuel_type_values_filtrados <- unique(na.omit(datos_fuel_filtrados$Fuel.Type.Code))

# Considerar todos los valores como válidos (incluyendo sospechosos)
valores_validos_fuel_type_filtrados <- fuel_type_values_filtrados

# No quedan valores sospechosos excluidos
valores_sospechosos_fuel_type_filtrados <- character(0)

# Mostrar resultados
cat("\nCantidad de valores válidos de Fuel.Type.Code (incluyendo sospechosos):", length(valores_validos_fuel_type_filtrados), "\n")
cat("Valores válidos:\n")
print(valores_validos_fuel_type_filtrados)

cat("\nCantidad de valores sospechosos de Fuel.Type.Code:", length(valores_sospechosos_fuel_type_filtrados), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_fuel_type_filtrados)


# Crear tabla de frecuencia solo con valores válidos (todos incluidos)
tabla_fuel_type_validos <- table(datos_fuel_filtrados$Fuel.Type.Code[datos_fuel_filtrados$Fuel.Type.Code %in% valores_validos_fuel_type_filtrados])

# Convertir a data.frame ordenado
tabla_ordenada_fuel_type <- as.data.frame(tabla_fuel_type_validos)
colnames(tabla_ordenada_fuel_type) <- c("Fuel.Type.Code", "Frecuencia")
tabla_ordenada_fuel_type <- tabla_ordenada_fuel_type[order(-tabla_ordenada_fuel_type$Frecuencia), ]

# Mostrar tabla final
print(tabla_ordenada_fuel_type)

#--------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE FUEL.TYPE.CODE ----------------#

# Calcular la frecuencia máxima (moda)
max_frecuencia_fuel_type <- max(tabla_ordenada_fuel_type$Frecuencia, na.rm = TRUE)

# Filtrar la(s) moda(s)
tabla_moda_fuel_type <- tabla_ordenada_fuel_type[tabla_ordenada_fuel_type$Frecuencia == max_frecuencia_fuel_type, ]

# Imprimir resultado modal
cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (FUEL.TYPE.CODE):\n")
print(tabla_moda_fuel_type)

#----------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA FUEL.TYPE.CODE -------------#

datatable(tabla_moda_fuel_type,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Fuel.Type.Code", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Fuel.Type.Code)"
          )
)

#------------- AGREGAR FILA DE TOTAL GENERAL EN TABLA FUEL.TYPE.CODE -------------------#

total_general_fuel_type <- sum(tabla_ordenada_fuel_type$Frecuencia, na.rm = TRUE)
fila_total_fuel_type <- data.frame(Fuel.Type.Code = "TOTAL", Frecuencia = total_general_fuel_type)
tabla_fuel_type_con_total <- bind_rows(tabla_ordenada_fuel_type, fila_total_fuel_type)


# Mostrar tabla con total
print(tabla_fuel_type_con_total)


#-------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA FUEL TYPE CODE VS EST. CARGA ---------#

library(DT)
library(htmltools)

datatable(tabla_fuel_type_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Fuel.Type.Code", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 7. Frecuencia de Estaciones de Carga por Fuel.Type.Code"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA FUEL TYPE CODE ----------------#


library(ggplot2)
library(dplyr)

# Renombrar tabla original a un nombre más claro para Fuel.Type.Code
tabla_frecuencia_fuel_type <- tabla_fuel_type_con_total

# Filtrar fila TOTAL si existe
tabla_frecuencia_fuel_type_filtrada <- tabla_frecuencia_fuel_type %>% 
  filter(Fuel.Type.Code != "TOTAL") %>%
  mutate(Frecuencia = as.numeric(Frecuencia))

# Crear gráfico de barras por Fuel.Type.Code
ggplot(tabla_frecuencia_fuel_type_filtrada, aes(x = reorder(Fuel.Type.Code, -Frecuencia), y = Frecuencia, fill = Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  labs(
    title = "Gráfica N° 7.1 Frecuencia Absoluta de Estaciones por Tipo de Combustible (Fuel.Type.Code)",
    x = "Tipo de Combustible",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = "inside",
    legend.position.inside = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )


#--------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA POR FUEL TYPE CODE --------------#

library(ggplot2)
library(dplyr)
library(scales)
library(ggrepel)  # <-- Añadir esta librería

# Preparar datos (igual que antes)
tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_type %>%
  filter(Fuel.Type.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    porcentaje = Frecuencia / sum(Frecuencia)
  ) %>%
  arrange(Frecuencia)

tabla_frecuencia_fuel_filtrada$Fuel.Type.Code <- factor(tabla_frecuencia_fuel_filtrada$Fuel.Type.Code, 
                                                        levels = tabla_frecuencia_fuel_filtrada$Fuel.Type.Code)

tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_filtrada %>%
  arrange(desc(Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

colores_por_fuel <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_frecuencia_fuel_filtrada$Fuel.Type.Code))),
  levels(tabla_frecuencia_fuel_filtrada$Fuel.Type.Code)
)

tabla_frecuencia_fuel_filtrada$color_etiqueta <- colores_por_fuel[as.character(tabla_frecuencia_fuel_filtrada$Fuel.Type.Code)]

# Gráfico circular con geom_label_repel para evitar amontonamiento
ggplot(tabla_frecuencia_fuel_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Fuel.Type.Code
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía para etiquetas (puedes ajustar o eliminar si quieres)
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con repel para evitar superposición
  geom_label_repel(
    aes(x = 2.5, y = pos, label = Frecuencia, color = Fuel.Type.Code),
    fill = NA,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8,
    show.legend = FALSE,
    nudge_x = 0.3,
    segment.color = "gray30",
    segment.size = 0.6,
    force = 1.5,
    max.overlaps = Inf
  ) +
  
  scale_fill_manual(values = colores_por_fuel) +
  scale_color_manual(values = colores_por_fuel) +  # Color de texto acorde a segmento
  
  labs(
    title = "Gráfica N° 7.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Tipo de Combustible (Fuel.Type.Code)",
    fill = "Fuel.Type.Code"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )


#------------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA FUEL TYPE CODE ----------------#

library(ggplot2)
library(dplyr)

# Renombrar tabla original a un nombre más claro para Fuel.Type.Code
tabla_frecuencia_fuel_type <- tabla_fuel_type_con_total

# Filtrar fila TOTAL si existe, convertir frecuencia a numérico y calcular frecuencia relativa
tabla_frecuencia_fuel_type_relativa <- tabla_frecuencia_fuel_type %>% 
  filter(Fuel.Type.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    Frecuencia_Relativa = Frecuencia / sum(Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_frecuencia_fuel_type_relativa, aes(x = reorder(Fuel.Type.Code, -Frecuencia_Relativa), y = Frecuencia_Relativa, fill = Frecuencia_Relativa)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = scales::percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 7.3 Frecuencia Relativa (%) de Estaciones de Carga por Tipo de Combustible (Fuel.Type.Code)",
    x = "Tipo de Combustible",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#--------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR FUEL TYPE CODE --------------#

library(ggplot2)
library(dplyr)
library(scales)
library(ggrepel)  # Para etiquetas repelentes

# Preparar datos (frecuencia relativa)
tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_type %>%
  filter(Fuel.Type.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    porcentaje = Frecuencia / sum(Frecuencia)
  ) %>%
  arrange(Frecuencia)

tabla_frecuencia_fuel_filtrada$Fuel.Type.Code <- factor(
  tabla_frecuencia_fuel_filtrada$Fuel.Type.Code, 
  levels = tabla_frecuencia_fuel_filtrada$Fuel.Type.Code
)

tabla_frecuencia_fuel_filtrada <- tabla_frecuencia_fuel_filtrada %>%
  arrange(desc(Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

colores_por_fuel <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_frecuencia_fuel_filtrada$Fuel.Type.Code))),
  levels(tabla_frecuencia_fuel_filtrada$Fuel.Type.Code)
)

tabla_frecuencia_fuel_filtrada$color_etiqueta <- colores_por_fuel[as.character(tabla_frecuencia_fuel_filtrada$Fuel.Type.Code)]

# Gráfico circular con etiquetas repelentes que muestran porcentaje
ggplot(tabla_frecuencia_fuel_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Fuel.Type.Code
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía para etiquetas (ajustables)
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas repelentes con porcentaje
  geom_label_repel(
    aes(x = 2.5, y = pos, label = scales::percent(porcentaje, accuracy = 0.1), color = Fuel.Type.Code),
    fill = NA,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8,
    show.legend = FALSE,
    nudge_x = 0.3,
    segment.color = "gray30",
    segment.size = 0.6,
    force = 1.5,
    max.overlaps = Inf
  ) +
  
  scale_fill_manual(values = colores_por_fuel) +
  scale_color_manual(values = colores_por_fuel) +  # Color de texto acorde al segmento
  
  labs(
    title = "Gráfica N° 7.4 Porcentaje de la Frecuencia Relativa de Estaciones de Carga por Tipo de Combustible (Fuel.Type.Code)",
    fill = "Fuel.Type.Code"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
```{r}
#---------------------- VARIABLE NOMINAL Status.Code ------------------------------#

#--------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Status.Code ---------#

# Obtener valores únicos no nulos de Status.Code (de datos originales, sin filtro)
status_code_values_raw <- unique(na.omit(datos$Status.Code))

#-------------- CLASIFICACIÓN DE VALORES DE Status.Code -------------#

# Clasificar valores válidos: solo letras y espacios
valores_validos_status_code_raw <- status_code_values_raw[grepl("^[A-Za-z ]+$", status_code_values_raw)]

# Clasificar valores sospechosos: contienen números, símbolos u otros caracteres
valores_sospechosos_status_code_raw <- status_code_values_raw[!grepl("^[A-Za-z ]+$", status_code_values_raw)]

#------------------- RESULTADOS EXPLORATORIOS ---------------------#

# Mostrar conteo de cada grupo
cat("Cantidad de valores válidos (solo letras): ", length(valores_validos_status_code_raw), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_status_code_raw), "\n")

# Mostrar los valores encontrados
cat("\nValores válidos:\n")
print(valores_validos_status_code_raw)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_status_code_raw)


#--- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Status.Code (US Y CA) ----------------#

# Filtrar solo datos de US y CA, y valores no nulos de Status.Code
datos_filtrados_status <- datos %>% 
  filter(Country %in% c("US", "CA") & !is.na(Status.Code))

# Obtener valores únicos de Status.Code
status_code_values_filtrados <- unique(na.omit(datos_filtrados_status$Status.Code))

# Clasificar válidos: solo letras y espacios
valores_validos_status_code_filtrados <- status_code_values_filtrados[grepl("^[A-Za-z ]+$", status_code_values_filtrados)]

# Clasificar sospechosos: contienen números, símbolos u otros caracteres
valores_sospechosos_status_code_filtrados <- status_code_values_filtrados[!grepl("^[A-Za-z ]+$", status_code_values_filtrados)]

# Mostrar resultados
cat("\nCantidad de valores válidos de Status.Code:", length(valores_validos_status_code_filtrados), "\n")
cat("Valores válidos:\n")
print(valores_validos_status_code_filtrados)

cat("\nCantidad de valores sospechosos de Status.Code:", length(valores_sospechosos_status_code_filtrados), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_status_code_filtrados)

# Crear tabla de frecuencia solo con valores válidos
tabla_status_code_validos <- table(datos_filtrados_status$Status.Code[datos_filtrados_status$Status.Code %in% valores_validos_status_code_filtrados])

# Convertir a data.frame ordenado
tabla_ordenada_status_code <- as.data.frame(tabla_status_code_validos)
colnames(tabla_ordenada_status_code) <- c("Status.Code", "Frecuencia")
tabla_ordenada_status_code <- tabla_ordenada_status_code[order(-tabla_ordenada_status_code$Frecuencia), ]

# Mostrar tabla final
print(tabla_ordenada_status_code)

#--------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Status.Code ----------------#

# Calcular la frecuencia máxima (moda)
max_frecuencia_status_code <- max(tabla_ordenada_status_code$Frecuencia, na.rm = TRUE)

# Filtrar la(s) moda(s)
tabla_moda_status_code <- tabla_ordenada_status_code[tabla_ordenada_status_code$Frecuencia == max_frecuencia_status_code, ]

# Imprimir resultado modal
cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Status.Code):\n")
print(tabla_moda_status_code)

#----------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Status.Code -------------#

datatable(tabla_moda_status_code,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Código de Estado", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Status Code)"
          )
)


#---------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA Status.Code -----------------#

tabla_ordenada_status_code <- datos_filtrados_status %>%
  count(Status.Code, name = "Frecuencia") %>%   # Contar frecuencia
  arrange(desc(Frecuencia))                     # Ordenar de mayor a menor


#------------- AGREGAR FILA DE TOTAL GENERAL EN TABLA Status.Code -------------------#

total_general_status_code <- sum(tabla_ordenada_status_code$Frecuencia, na.rm = TRUE)
fila_total_status_code <- data.frame(Status.Code = "TOTAL", Frecuencia = total_general_status_code)
tabla_status_code_con_total <- bind_rows(tabla_ordenada_status_code, fila_total_status_code)

#-------------------- MOSTRAR TABLA RESULTANTE -----------------------------#

print(tabla_status_code_con_total)


#----------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA Status.Code ----------------#

library(DT)
library(htmltools)

datatable(tabla_status_code_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Código de Estado de Carga", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 9. Frecuencia Absoluta de Estaciones de Carga por Código de Estado (Status.Code)"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA POR Status.Code ----------------#

library(ggplot2)
library(dplyr)

# Renombrar tabla original a un nombre más claro
tabla_frecuencia_status_code <- tabla_status_code_con_total

# Filtrar fila TOTAL si existe
tabla_frecuencia_status_code_filtrada <- tabla_frecuencia_status_code %>% 
  filter(Status.Code != "TOTAL") %>%
  mutate(Frecuencia = as.numeric(Frecuencia))

# Crear gráfico de barras por códigos de estado de carga
ggplot(tabla_frecuencia_status_code_filtrada, aes(x = reorder(Status.Code, -Frecuencia), y = Frecuencia, fill = Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  labs(
    title = "Gráfica N° 9.1 Frecuencia Absoluta de Estaciones de Carga por Código de Estado (Status.Code)",
    x = "Código de Estado de Carga",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = "inside",
    legend.position.inside = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )


#--------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA POR Status.Code --------------#


library(ggplot2)
library(dplyr)
library(scales)
library(ggrepel)  # para geom_label_repel

# Preparar datos: filtrar, convertir, calcular porcentaje y posiciones para el gráfico
tabla_frecuencia_status_code_filtrada <- tabla_status_code_con_total %>%
  filter(Status.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    porcentaje = Frecuencia / sum(Frecuencia)
  ) %>%
  arrange(Frecuencia)  # Orden ascendente para asignar colores

# Reordenar factor para mantener el orden de colores
tabla_frecuencia_status_code_filtrada$Status.Code <- factor(
  tabla_frecuencia_status_code_filtrada$Status.Code,
  levels = tabla_frecuencia_status_code_filtrada$Status.Code
)

# Calcular posiciones para segmentos circulares
tabla_frecuencia_status_code_filtrada <- tabla_frecuencia_status_code_filtrada %>%
  arrange(desc(Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Crear paleta de colores personalizada
colores_por_codigo <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_frecuencia_status_code_filtrada$Status.Code))),
  levels(tabla_frecuencia_status_code_filtrada$Status.Code)
)

# Asignar color a etiquetas
tabla_frecuencia_status_code_filtrada$color_etiqueta <- colores_por_codigo[
  as.character(tabla_frecuencia_status_code_filtrada$Status.Code)
]

# Gráfico circular con geom_label_repel para evitar amontonamiento
ggplot(tabla_frecuencia_status_code_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Status.Code
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía para etiquetas
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con repel para evitar superposición y que roten adecuadamente
  geom_label_repel(
    aes(x = 2.5, y = pos, label = Frecuencia, color = Status.Code),
    fill = NA,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8,
    show.legend = FALSE,
    nudge_x = 0.3,
    segment.color = "gray30",
    segment.size = 0.6,
    force = 1.5,
    max.overlaps = Inf,
    direction = "y",
    angle = 0
  ) +
  
  scale_fill_manual(values = colores_por_codigo) +
  scale_color_manual(values = colores_por_codigo) +  # Color de texto acorde a segmento
  
  labs(
    title = "Gráfica N° 9.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Código de Estado (Status.Code)",
    fill = "Código"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#------------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA POR Status.Code ----------------#

library(ggplot2)
library(dplyr)

# Renombrar tabla original a un nombre más claro
tabla_frecuencia_status_code <- tabla_status_code_con_total

# Filtrar fila TOTAL si existe y calcular frecuencia relativa
tabla_frecuencia_status_code_filtrada <- tabla_frecuencia_status_code %>% 
  filter(Status.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    Frecuencia_Relativa = Frecuencia / sum(Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_frecuencia_status_code_filtrada, aes(x = reorder(Status.Code, -Frecuencia_Relativa), y = Frecuencia_Relativa, fill = Frecuencia_Relativa)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = scales::percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  labs(
    title = "Gráfica N° 9.3 Frecuencia Relativa (%) de Estaciones de Carga por Código de Estado (Status.Code)",
    x = "Código de Estado de Carga",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = "inside",
    legend.position.inside = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#--------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR Status.Code --------------#

library(ggplot2)
library(dplyr)
library(scales)
library(ggrepel)  # para geom_label_repel

# Preparar datos: filtrar, convertir, calcular porcentaje y posiciones para el gráfico
tabla_frecuencia_status_code_filtrada <- tabla_status_code_con_total %>%
  filter(Status.Code != "TOTAL") %>%
  mutate(
    Frecuencia = as.numeric(Frecuencia),
    porcentaje = Frecuencia / sum(Frecuencia)
  ) %>%
  arrange(Frecuencia)  # Orden ascendente para asignar colores

# Reordenar factor para mantener el orden de colores
tabla_frecuencia_status_code_filtrada$Status.Code <- factor(
  tabla_frecuencia_status_code_filtrada$Status.Code,
  levels = tabla_frecuencia_status_code_filtrada$Status.Code
)

# Calcular posiciones para segmentos circulares
tabla_frecuencia_status_code_filtrada <- tabla_frecuencia_status_code_filtrada %>%
  arrange(desc(Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2,
    angle = 90 - 360 * pos,  # ángulo para rotar etiquetas
    hjust = ifelse(angle < -90, 1, 0),  # ajuste horizontal según ángulo
    angle = ifelse(angle < -90, angle + 180, angle)  # ajustar ángulo para no voltear texto
  )

# Crear paleta de colores personalizada
colores_por_codigo <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_frecuencia_status_code_filtrada$Status.Code))),
  levels(tabla_frecuencia_status_code_filtrada$Status.Code)
)

# Asignar color a etiquetas
tabla_frecuencia_status_code_filtrada$color_etiqueta <- colores_por_codigo[
  as.character(tabla_frecuencia_status_code_filtrada$Status.Code)
]

# Gráfico circular con geom_label_repel para evitar amontonamiento y rotar etiquetas
ggplot(tabla_frecuencia_status_code_filtrada, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Status.Code
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía para etiquetas
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con repel, rotadas dinámicamente
  geom_label_repel(
    data = tabla_frecuencia_status_code_filtrada,
    aes(x = 2.5, y = pos, label = scales::percent(porcentaje, accuracy = 0.1), color = Status.Code),
    fill = NA,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8,
    show.legend = FALSE,
    nudge_x = 0.3,
    segment.color = "gray30",
    segment.size = 0.6,
    force = 1.5,
    max.overlaps = Inf,
    direction = "y",
    angle = tabla_frecuencia_status_code_filtrada$angle,
    hjust = tabla_frecuencia_status_code_filtrada$hjust
  ) +
  
  scale_fill_manual(values = colores_por_codigo) +
  scale_color_manual(values = colores_por_codigo) +  # Color de texto acorde a segmento
  
  labs(
    title = "Gráfica N° 9.4 Porcentaje de la Frecuencia Relativa de Estaciones de Carga por Código de Estado (Status.Code)",
    fill = "Código"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

```
```{r}

#------------------- VARIABLE NOMINAL: Station.Name -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Station.Name --------------#

# Copia de respaldo por seguridad
datos$Station.Name_original <- datos$Station.Name

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$Station.Name <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$Station.Name)

# Reemplazar múltiples espacios por uno solo
datos$Station.Name <- gsub("\\s+", " ", datos$Station.Name)

# Eliminar espacios al inicio y fin
datos$Station.Name <- trimws(datos$Station.Name)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE Station.Name ----------------#

# Extraer valores únicos no nulos después de limpieza
Station.Name_values <- unique(na.omit(datos$Station.Name))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_Station.Name <- Station.Name_values[grepl(pattern_valido, Station.Name_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_Station.Name <- Station.Name_values[!grepl(pattern_valido, Station.Name_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE Station.Name ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_Station.Name), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_Station.Name), "\n")

cat("\nValores válidos:\n")
print(valores_validos_Station.Name)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_Station.Name)

#---------------------- FILTRO NOMBRE DE ESTACIÓN POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(Station.Name) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(Station.Name) %>%
  unique() %>%
  na.omit()

cat("Nombre de la estación únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Nombre de la estación en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nNombre de la estación únicas en Canadá:", length(ciudades_canada), "\n")
cat("Nombre de la estación en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Station.Name -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(Station.Name))

# Crear tabla de frecuencia con valores válidos
tabla_Station.Name_validos <- datos_filtrados %>%
  filter(Station.Name %in% valores_validos_Station.Name) %>%
  count(Station.Name, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de Station.Name:", nrow(tabla_Station.Name_validos), "\n")
cat("Valores válidos:\n")
print(tabla_Station.Name_validos$Station.Name)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de Station.Name:", length(valores_sospechosos_Station.Name), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_Station.Name)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Station.Name --------------#

max_frecuencia_Station.Name <- max(tabla_Station.Name_validos$Frecuencia, na.rm = TRUE)
tabla_moda_Station.Name <- tabla_Station.Name_validos %>% filter(Frecuencia == max_frecuencia_Station.Name)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Station.Name):\n")
print(tabla_moda_Station.Name)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Station.Name ------------#

datatable(tabla_moda_Station.Name,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Direcciones de intersección", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla  - Resumen Estadístico por Frecuencia (Moda de Nombre de la estación)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA Station.Name ----------------------#

tabla_ordenada_Station.Name <- tabla_Station.Name_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – Station.Name -----------------------#

tabla_ordenada_Station.Name <- tabla_ordenada_Station.Name %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – Station.Name ----------------#

tabla_por_grupo_Station.Name <- tabla_ordenada_Station.Name %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – Station.Name ---------------------------#

total_general_Station.Name <- sum(tabla_por_grupo_Station.Name$Total_Frecuencia, na.rm = TRUE)
fila_total_Station.Name <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_Station.Name)
tabla_por_grupo_Station.Name_con_total <- bind_rows(tabla_por_grupo_Station.Name, fila_total_Station.Name)

#------------------ MOSTRAR TABLA RESULTANTE – Station.Name -------------------------------#

print(tabla_por_grupo_Station.Name_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA NOMBRE DE ESTACIÓN VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_Station.Name_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla Nº15. Frecuencia de Estaciones de Carga Nombre de la estación"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y NOMBRE DE ESTACIÓN ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_Station.Name %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(Station.Name, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA NOMBRE DE ESTACIÓN VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # NOMBRE DE ESTACIÓN 
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Nombre de la estación(Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla: Nombre de las estaciónes agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA NOMBRE DE ESTACIÓN ---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para Station.Name por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Gráfica N° 15.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Nombre de Estación",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA NOMBRE DE ESTACIÓN --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Gráfica N° 15.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Rango de Nombre de Estación",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA NOMBRE DE ESTACIÓN -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 15.2 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Nombre de Estación",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA NOMBRE DE ESTACIÓN -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica N° 15.3 Distribución de la Frecuencia Relativa (%) de Estaciones de Carga por Rango de Nombre de Estación",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
```{r}

#------------------- VARIABLE NOMINAL: Station.Phone -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Station.Phone --------------#

# Copia de respaldo por seguridad
datos$Station.Phone_original <- datos$Station.Phone

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$Station.Phone <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$Station.Phone)

# Reemplazar múltiples espacios por uno solo
datos$Station.Phone <- gsub("\\s+", " ", datos$Station.Phone)

# Eliminar espacios al inicio y fin
datos$Station.Phone <- trimws(datos$Station.Phone)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE Station.Phone ----------------#

# Extraer valores únicos no nulos después de limpieza
Station.Phone_values <- unique(na.omit(datos$Station.Phone))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_Station.Phone <- Station.Phone_values[grepl(pattern_valido, Station.Phone_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_Station.Phone <- Station.Phone_values[!grepl(pattern_valido, Station.Phone_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE Station.Phone ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_Station.Phone), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_Station.Phone), "\n")

cat("\nValores válidos:\n")
print(valores_validos_Station.Phone)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_Station.Phone)

#---------------------- FILTRO TELEFONOS DE ESTACION POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(Station.Phone) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(Station.Phone) %>%
  unique() %>%
  na.omit()

cat("Cantidad de Teléfonos de la estación únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Ciudades únicas en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nCantidad de Teléfonos de la estación únicas en Canadá:", length(ciudades_canada), "\n")
cat("Teléfono de la estación únicas en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Station.Phone -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(Station.Phone))

# Crear tabla de frecuencia con valores válidos
tabla_Station.Phone_validos <- datos_filtrados %>%
  filter(Station.Phone %in% valores_validos_Station.Phone) %>%
  count(Station.Phone, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de Station.Phone:", nrow(tabla_Station.Phone_validos), "\n")
cat("Valores válidos:\n")
print(tabla_Station.Phone_validos$Station.Phone)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de Station.Phone:", length(valores_sospechosos_Station.Phone), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_Station.Phone)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Station.Phone --------------#

max_frecuencia_Station.Phone <- max(tabla_Station.Phone_validos$Frecuencia, na.rm = TRUE)
tabla_moda_Station.Phone <- tabla_Station.Phone_validos %>% filter(Frecuencia == max_frecuencia_Station.Phone)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Station.Phone):\n")
print(tabla_moda_Station.Phone)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Station.Phone ------------#

datatable(tabla_moda_Station.Phone,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Teléfonos de la estación", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Teléfonos de la estación)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA Station.Phone ----------------------#

tabla_ordenada_Station.Phone <- tabla_Station.Phone_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – Station.Phone -----------------------#

tabla_ordenada_Station.Phone <- tabla_ordenada_Station.Phone %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – Station.Phone ----------------#

tabla_por_grupo_Station.Phone <- tabla_ordenada_Station.Phone %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – Station.Phone ---------------------------#

total_general_Station.Phone <- sum(tabla_por_grupo_Station.Phone$Total_Frecuencia, na.rm = TRUE)
fila_total_Station.Phone <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_Station.Phone)
tabla_por_grupo_Station.Phone_con_total <- bind_rows(tabla_por_grupo_Station.Phone, fila_total_Station.Phone)

#------------------ MOSTRAR TABLA RESULTANTE – Station.Phone -------------------------------#

print(tabla_por_grupo_Station.Phone_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA Station.Phone VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_Station.Phone_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 16. Frecuencia Absoluta Teléfonos de la estación"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y TELEFONO DE ESTACIÓN ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_Station.Phone %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(Station.Phone, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA TELEFONO DE ESTACIÓN VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # TELÉFONO DE ESTACIÓN
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "TELÉFONO DE ESTACIÓN (Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla: Teléfonos de la estación agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA POR TELÉFONO DE ESTACIÓN ---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para Station.Phone por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Gráfica N° 16.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Teléfono de Estación",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA POR Station.Phone --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Gráfica N° 16.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Rango de Teléfono de Estación",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA Teléfono de la estación -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 16.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Teléfono de Estación",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR Station.Phone -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica N° 16.4 Distribución de la Frecuencia Relativa (%) de Estaciones de Carga por Rango de Teléfono de Estación",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
```{r}

#------------------- VARIABLE NOMINAL: Access.Detail.Code -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Access.Detail.Code --------------#

# Copia de respaldo por seguridad
datos$Access.Detail.Code_original <- datos$Access.Detail.Code

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$Access.Detail.Code <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$Access.Detail.Code)

# Reemplazar múltiples espacios por uno solo
datos$Access.Detail.Code <- gsub("\\s+", " ", datos$Access.Detail.Code)

# Eliminar espacios al inicio y fin
datos$Access.Detail.Code <- trimws(datos$Access.Detail.Code)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE Access.Detail.Code ----------------#

# Extraer valores únicos no nulos después de limpieza
Access.Detail.Code_values <- unique(na.omit(datos$Access.Detail.Code))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_Access.Detail.Code <- Access.Detail.Code_values[grepl(pattern_valido, Access.Detail.Code_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_Access.Detail.Code <- Access.Detail.Code_values[!grepl(pattern_valido, Access.Detail.Code_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE Access.Detail.Code ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_Access.Detail.Code), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_Access.Detail.Code), "\n")

cat("\nValores válidos:\n")
print(valores_validos_Access.Detail.Code)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_Access.Detail.Code)

#---------------------- FILTRO CODIGO DE DETALLE DE ACCESO POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(Access.Detail.Code) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(Access.Detail.Code) %>%
  unique() %>%
  na.omit()

cat("Cantidad de Código de detalle de acceso únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Ciudades únicas en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nCantidad de Código de detalle de acceso únicas en Canadá:", length(ciudades_canada), "\n")
cat("Teléfono de la estación únicas en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Access.Detail.Code -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(Access.Detail.Code))

# Crear tabla de frecuencia con valores válidos
tabla_Access.Detail.Code_validos <- datos_filtrados %>%
  filter(Access.Detail.Code %in% valores_validos_Access.Detail.Code) %>%
  count(Access.Detail.Code, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de Access.Detail.Code:", nrow(tabla_Access.Detail.Code_validos), "\n")
cat("Valores válidos:\n")
print(tabla_Access.Detail.Code_validos$Access.Detail.Code)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de Access.Detail.Code:", length(valores_sospechosos_Access.Detail.Code), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_Access.Detail.Code)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Access.Detail.Code --------------#

max_frecuencia_Access.Detail.Code <- max(tabla_Access.Detail.Code_validos$Frecuencia, na.rm = TRUE)
tabla_moda_Access.Detail.Code <- tabla_Access.Detail.Code_validos %>% filter(Frecuencia == max_frecuencia_Access.Detail.Code)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Access.Detail.Code):\n")
print(tabla_moda_Access.Detail.Code)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Access.Detail.Code ------------#

datatable(tabla_moda_Access.Detail.Code,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Código de detalle de acceso", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Código de detalle de acceso)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA Access.Detail.Code ----------------------#

tabla_ordenada_Access.Detail.Code <- tabla_Access.Detail.Code_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – Access.Detail.Code -----------------------#

tabla_ordenada_Access.Detail.Code <- tabla_ordenada_Access.Detail.Code %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – Access.Detail.Code ----------------#

tabla_por_grupo_Access.Detail.Code <- tabla_ordenada_Access.Detail.Code %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – Access.Detail.Code ---------------------------#

total_general_Access.Detail.Code <- sum(tabla_por_grupo_Access.Detail.Code$Total_Frecuencia, na.rm = TRUE)
fila_total_Access.Detail.Code <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_Access.Detail.Code)
tabla_por_grupo_Access.Detail.Code_con_total <- bind_rows(tabla_por_grupo_Access.Detail.Code, fila_total_Access.Detail.Code)

#------------------ MOSTRAR TABLA RESULTANTE – Access.Detail.Code -------------------------------#

print(tabla_por_grupo_Access.Detail.Code_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA CODIGO DE DETALLE DE ACCESO VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_Access.Detail.Code_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 17. Frecuencia Absoluta Código de detalle de acceso"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y CODIGO DE DETALLE DE ACCESO  ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_Access.Detail.Code %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(Access.Detail.Code, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA TELEFONO DE ESTACIÓN VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # TELÉFONO DE ESTACIÓN
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Código de detalle de acceso(Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla: Código de detalle de acceso agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA POR CODIGO DE DETALLE DE ACCESO---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para Access.Detail.Code por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Gráfica N° 17.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Código Detallado de Acceso",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA POR Código de detalle de acceso --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Gráfica N° 17.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Rango de Código Detallado de Acceso",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA Código de detalle de acceso -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 17.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Código Detallado de Acceso

",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR Access.Detail.Code -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica N° 17.4 Distribución de la Frecuencia Relativa (%) de Estaciones de Carga por Rango de Código Detallado de Acceso",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
```{r}

#------------------- VARIABLE NOMINAL: NG.Fill.Type.Code (Codigo de tipo de llenado NG) -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE NG.Fill.Type.Code --------------#

# Copia de respaldo por seguridad
datos$NG.Fill.Type.Code_original <- datos$NG.Fill.Type.Code

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$NG.Fill.Type.Code <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$NG.Fill.Type.Code)

# Reemplazar múltiples espacios por uno solo
datos$NG.Fill.Type.Code <- gsub("\\s+", " ", datos$NG.Fill.Type.Code)

# Eliminar espacios al inicio y fin
datos$NG.Fill.Type.Code <- trimws(datos$NG.Fill.Type.Code)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE NG.Fill.Type.Code ----------------#

# Extraer valores únicos no nulos después de limpieza
NG.Fill.Type.Code_values <- unique(na.omit(datos$NG.Fill.Type.Code))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_NG.Fill.Type.Code <- NG.Fill.Type.Code_values[grepl(pattern_valido, NG.Fill.Type.Code_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_NG.Fill.Type.Code <- NG.Fill.Type.Code_values[!grepl(pattern_valido, NG.Fill.Type.Code_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE NG.Fill.Type.Code ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_NG.Fill.Type.Code), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_NG.Fill.Type.Code), "\n")

cat("\nValores válidos:\n")
print(valores_validos_NG.Fill.Type.Code)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_NG.Fill.Type.Code)

#---------------------- FILTRO CODIGO DE TIPO DE LLENADO NG POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(NG.Fill.Type.Code) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(NG.Fill.Type.Code) %>%
  unique() %>%
  na.omit()

cat("Cantidad de Código de tipo de llenado NG únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Código de tipo de llenado NG en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nCantidad de Código de tipo de llenado NGúnicas en Canadá:", length(ciudades_canada), "\n")
cat("Código de tipo de llenado NG en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE NG.Fill.Type.Code -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(NG.Fill.Type.Code))

# Crear tabla de frecuencia con valores válidos
tabla_NG.Fill.Type.Code_validos <- datos_filtrados %>%
  filter(NG.Fill.Type.Code %in% valores_validos_NG.Fill.Type.Code) %>%
  count(NG.Fill.Type.Code, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de NG.Fill.Type.Code:", nrow(tabla_NG.Fill.Type.Code_validos), "\n")
cat("Valores válidos:\n")
print(tabla_NG.Fill.Type.Code_validos$NG.Fill.Type.Code)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de NG.Fill.Type.Code:", length(valores_sospechosos_NG.Fill.Type.Code), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_NG.Fill.Type.Code)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE NG.Fill.Type.Code --------------#

max_frecuencia_NG.Fill.Type.Code <- max(tabla_NG.Fill.Type.Code_validos$Frecuencia, na.rm = TRUE)
tabla_moda_NG.Fill.Type.Code <- tabla_NG.Fill.Type.Code_validos %>% filter(Frecuencia == max_frecuencia_NG.Fill.Type.Code)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (NG.Fill.Type.Code):\n")
print(tabla_moda_NG.Fill.Type.Code)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA NG.Fill.Type.Code ------------#

datatable(tabla_moda_NG.Fill.Type.Code,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Código de detalle de acceso", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Código de tipo de llenado NG)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA NG.Fill.Type.Code ----------------------#

tabla_ordenada_NG.Fill.Type.Code <- tabla_NG.Fill.Type.Code_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – NG.Fill.Type.Code -----------------------#

tabla_ordenada_NG.Fill.Type.Code <- tabla_ordenada_NG.Fill.Type.Code %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – NG.Fill.Type.Code ----------------#

tabla_por_grupo_NG.Fill.Type.Code <- tabla_ordenada_NG.Fill.Type.Code %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – NG.Fill.Type.Code ---------------------------#

total_general_NG.Fill.Type.Code <- sum(tabla_por_grupo_NG.Fill.Type.Code$Total_Frecuencia, na.rm = TRUE)
fila_total_NG.Fill.Type.Code <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_NG.Fill.Type.Code)
tabla_por_grupo_NG.Fill.Type.Code_con_total <- bind_rows(tabla_por_grupo_NG.Fill.Type.Code, fila_total_NG.Fill.Type.Code)

#------------------ MOSTRAR TABLA RESULTANTE – NG.Fill.Type.Code -------------------------------#

print(tabla_por_grupo_NG.Fill.Type.Code_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA CODIGO DE TIPO DE LLENADO NG VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_NG.Fill.Type.Code_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla 2. Frecuencia Absoluta Código de tipo de llenado NG"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y CODIGO DE TIPO DE LLENADO NG  ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_NG.Fill.Type.Code %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(NG.Fill.Type.Code, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA CODIGO DE TIPO DE LLENADO NG VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # CODIGO DE TIPO DE LLENADO NG
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Código de detalle de acceso(Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla Nº18: Código de tipo de llenado NG agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA POR CODIGO DE TIPO DE LLENADO NG---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para NG.Fill.Type.Code por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Gráfica N° 18.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Tipo de Llenado de Gas Natural (NG.Fill.Type.Code)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA POR Código de tipo de llenado NG --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Gráfica N° 18.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Rango de Tipo de Llenado de Gas Natural (NG.Fill.Type.Code)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA Código de tipo de llenado NG -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica N° 18.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Tipo de Llenado de Gas Natural (NG.Fill.Type.Code)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR Código de tipo de llenado NG -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica N° 18.4 Distribución de la Frecuencia Relativa (%) de Estaciones de Carga por Rango de Tipo de Llenado de Gas Natural (NG.Fill.Type.Code)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
```{r}

#------------------- VARIABLE NOMINAL: Cards.Accepted (Tarjetas aceptadas) -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Cards.Accepted --------------#

# Copia de respaldo por seguridad
datos$Cards.Accepted_original <- datos$Cards.Accepted

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$Cards.Accepted <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$Cards.Accepted)

# Reemplazar múltiples espacios por uno solo
datos$Cards.Accepted <- gsub("\\s+", " ", datos$Cards.Accepted)

# Eliminar espacios al inicio y fin
datos$Cards.Accepted <- trimws(datos$Cards.Accepted)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE Cards.Accepted ----------------#

# Extraer valores únicos no nulos después de limpieza
Cards.Accepted_values <- unique(na.omit(datos$Cards.Accepted))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_Cards.Accepted <- Cards.Accepted_values[grepl(pattern_valido, Cards.Accepted_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_Cards.Accepted <- Cards.Accepted_values[!grepl(pattern_valido, Cards.Accepted_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE Cards.Accepted ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_Cards.Accepted), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_Cards.Accepted), "\n")

cat("\nValores válidos:\n")
print(valores_validos_Cards.Accepted)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_Cards.Accepted)

#---------------------- FILTRO TARJETAS ACEPTADAS POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(Cards.Accepted) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(Cards.Accepted) %>%
  unique() %>%
  na.omit()

cat("Tarjetas aceptadas únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Tarjetas aceptadas en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nTarjetas aceptadas únicas en Canadá:", length(ciudades_canada), "\n")
cat("Tarjetas aceptadas en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Cards.Accepted -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(Cards.Accepted))

# Crear tabla de frecuencia con valores válidos
tabla_Cards.Accepted_validos <- datos_filtrados %>%
  filter(Cards.Accepted %in% valores_validos_Cards.Accepted) %>%
  count(Cards.Accepted, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de Cards.Accepted:", nrow(tabla_Cards.Accepted_validos), "\n")
cat("Valores válidos:\n")
print(tabla_Cards.Accepted_validos$Cards.Accepted)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de Cards.Accepted:", length(valores_sospechosos_Cards.Accepted), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_Cards.Accepted)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Cards.Accepted --------------#

max_frecuencia_Cards.Accepted <- max(tabla_Cards.Accepted_validos$Frecuencia, na.rm = TRUE)
tabla_moda_Cards.Accepted <- tabla_Cards.Accepted_validos %>% filter(Frecuencia == max_frecuencia_Cards.Accepted)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Cards.Accepted):\n")
print(tabla_moda_Cards.Accepted)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Cards.Accepted ------------#

datatable(tabla_moda_Cards.Accepted,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Tarjetas aceptadas", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Tarjetas aceptadas)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA Cards.Accepted ----------------------#

tabla_ordenada_Cards.Accepted <- tabla_Cards.Accepted_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – Cards.Accepted -----------------------#

tabla_ordenada_Cards.Accepted <- tabla_ordenada_Cards.Accepted %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – Cards.Accepted ----------------#

tabla_por_grupo_Cards.Accepted <- tabla_ordenada_Cards.Accepted %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – Cards.Accepted ---------------------------#

total_general_Cards.Accepted <- sum(tabla_por_grupo_Cards.Accepted$Total_Frecuencia, na.rm = TRUE)
fila_total_Cards.Accepted <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_Cards.Accepted)
tabla_por_grupo_Cards.Accepted_con_total <- bind_rows(tabla_por_grupo_Cards.Accepted, fila_total_Cards.Accepted)

#------------------ MOSTRAR TABLA RESULTANTE – Cards.Accepted -------------------------------#

print(tabla_por_grupo_Cards.Accepted_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA TARJETAS ACEPTADAS VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_Cards.Accepted_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla Nº19. Frecuencia de Estaciones de Carga por Tarjetas aceptadas"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y TARJETAS ACEPTADAS  ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_Cards.Accepted %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(Cards.Accepted, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA TARJETAS ACEPTADAS VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # TARJETAS ACEPTADAS
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Tarjetas aceptadas(Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla: Tarjetas aceptadas agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA TARJETAS ACEPTADAS---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para Cards.Accepted por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Grafica Nº19.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Tarjetas Aceptadas (Cards.Accepted)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA TARJETAS ACEPTADAS --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Grafica Nº19.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Rango de Tarjetas Aceptadas (Cards.Accepted)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA TARJETAS ACEPTADAS -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica Nº19.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Tarjetas Aceptadas (Cards.Accepted)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR TARJETAS ACEPTADAS -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica Nº19.4 Distribución de la Frecuencia Relativa (%) de Estaciones de Carga por Rango de Tarjetas Aceptadas (Cards.Accepted)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
```{r}

#------------------- VARIABLE NOMINAL: Street.Address(DIRECCIÓN) -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Street.Address --------------#

# Copia de respaldo por seguridad
datos$Street.Address_original <- datos$Street.Address

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$Street.Address <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$Street.Address)

# Reemplazar múltiples espacios por uno solo
datos$Street.Address <- gsub("\\s+", " ", datos$Street.Address)

# Eliminar espacios al inicio y fin
datos$Street.Address <- trimws(datos$Street.Address)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE Street.Address ----------------#

# Extraer valores únicos no nulos después de limpieza
Street.Address_values <- unique(na.omit(datos$Street.Address))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_Street.Address <- Street.Address_values[grepl(pattern_valido, Street.Address_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_Street.Address <- Street.Address_values[!grepl(pattern_valido, Street.Address_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE Street.Address ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_Street.Address), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_Street.Address), "\n")

cat("\nValores válidos:\n")
print(valores_validos_Street.Address)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_Street.Address)

#---------------------- FILTRO DIRECCION DE ESTACION DE CARGA POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(Street.Address) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(Street.Address) %>%
  unique() %>%
  na.omit()

cat("Dirección de Estacion de carga únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Dirección de Estacion de carga en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nDirección de Estacion de carga en Canadá:", length(ciudades_canada), "\n")
cat("Dirección de Estacion de carga en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Street.Address -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(Street.Address))

# Crear tabla de frecuencia con valores válidos
tabla_Street.Address_validos <- datos_filtrados %>%
  filter(Street.Address %in% valores_validos_Street.Address) %>%
  count(Street.Address, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de Street.Address:", nrow(tabla_Street.Address_validos), "\n")
cat("Valores válidos:\n")
print(tabla_Street.Address_validos$Street.Address)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de Street.Address:", length(valores_sospechosos_Street.Address), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_Street.Address)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Street.Address --------------#

max_frecuencia_Street.Address <- max(tabla_Street.Address_validos$Frecuencia, na.rm = TRUE)
tabla_moda_Street.Address <- tabla_Street.Address_validos %>% filter(Frecuencia == max_frecuencia_Street.Address)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Street.Address):\n")
print(tabla_moda_Street.Address)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Street.Address ------------#

datatable(tabla_moda_Street.Address,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Dirección de Estacion de carga", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla - Resumen Estadístico por Frecuencia (Moda de Dirección de Estacion de carga)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA Street.Address ----------------------#

tabla_ordenada_Street.Address <- tabla_Street.Address_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – Street.Address -----------------------#

tabla_ordenada_Street.Address <- tabla_ordenada_Street.Address %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – Street.Address ----------------#

tabla_por_grupo_Street.Address <- tabla_ordenada_Street.Address %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – Street.Address ---------------------------#

total_general_Street.Address <- sum(tabla_por_grupo_Street.Address$Total_Frecuencia, na.rm = TRUE)
fila_total_Street.Address <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_Street.Address)
tabla_por_grupo_Street.Address_con_total <- bind_rows(tabla_por_grupo_Street.Address, fila_total_Street.Address)

#------------------ MOSTRAR TABLA RESULTANTE – Street.Address -------------------------------#

print(tabla_por_grupo_Street.Address_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA DIRECCIÓN VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_Street.Address_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla Nº24 Frecuencia por Rango por Dirección de Estacion de carga"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y DIRECCION DE ESTACION DE CARGA  ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_Street.Address %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(Street.Address, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA DIRECCION VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # DIRECCION DE ESTACION DE CARGA
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Dirección de Estacion de carga(Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla: Dirección de Estacion de carga agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA DIRECCION DE ESTACION DE CARGA ---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para Street.Address por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Gráfica Nº24.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Direcciones (Street.Address)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA DIRECCION DE ESTACION DE CARGA--------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Gráfica Nº24.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Rango de Direcciones (Street.Address)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA DIRECCION DE ESTACION DE CARGA -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica Nº24.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Direcciones (Street.Address)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR DIRECCION DE ESTACION DE CARGA -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica Nº24.4 Distribución de la Frecuencia Relativa (%) de Estaciones de Carga por Rango de Direcciones (Street.Address)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
```{r}

#------------------- VARIABLE NOMINAL: Intersection.Directions(Direcciones de intersección) -------------------------------#

#--------------- EXTRACCIÓN Y LIMPIEZA DE LA VARIABLE Intersection.Directions --------------#

# Copia de respaldo por seguridad
datos$Intersection.Directions_original <- datos$Intersection.Directions

# Reemplazar todo carácter que NO sea letra (con acentos), espacio o ñ/ü → por espacio
datos$Intersection.Directions <- gsub("[^A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]", " ", datos$Intersection.Directions)

# Reemplazar múltiples espacios por uno solo
datos$Intersection.Directions <- gsub("\\s+", " ", datos$Intersection.Directions)

# Eliminar espacios al inicio y fin
datos$Intersection.Directions <- trimws(datos$Intersection.Directions)

#-------------- CLASIFICACIÓN Y VALIDACIÓN DE VALORES DE Intersection.Directions ----------------#

# Extraer valores únicos no nulos después de limpieza
Intersection.Directions_values <- unique(na.omit(datos$Intersection.Directions))

# Clasificar valores válidos: solo letras (con tildes), espacios y guiones
pattern_valido <- "^[A-Za-zÁÉÍÓÚáéíóúÑñüÜ \\-]+$"
valores_validos_Intersection.Directions <- Intersection.Directions_values[grepl(pattern_valido, Intersection.Directions_values)]

# Valores sospechosos: no cumplen patrón válido
valores_sospechosos_Intersection.Directions <- Intersection.Directions_values[!grepl(pattern_valido, Intersection.Directions_values)]

#-------------- RESULTADOS EXPLORATORIOS - VARIABLE Intersection.Directions ----------------------#

cat("Cantidad de valores válidos (solo letras, espacios o guiones): ", length(valores_validos_Intersection.Directions), "\n")
cat("Cantidad de valores sospechosos (con símbolos, números, etc.): ", length(valores_sospechosos_Intersection.Directions), "\n")

cat("\nValores válidos:\n")
print(valores_validos_Intersection.Directions)

cat("\nValores sospechosos:\n")
print(valores_sospechosos_Intersection.Directions)

#---------------------- FILTRO DIRECCIONES DE INTERSECCIÓN POR PAÍS --------------------------------#

ciudades_eeuu <- datos %>%
  filter(Country == "US") %>%
  pull(Intersection.Directions) %>%
  unique() %>%
  na.omit()

ciudades_canada <- datos %>%
  filter(Country == "CA") %>%
  pull(Intersection.Directions) %>%
  unique() %>%
  na.omit()

cat("Direcciones de intersección únicas en EE.UU.:", length(ciudades_eeuu), "\n")
cat("Direcciones de intersección en EE.UU.:\n")
print(ciudades_eeuu)

cat("\nDirecciones de intersección en Canadá:", length(ciudades_canada), "\n")
cat("Direcciones de intersección en Canadá:\n")
print(ciudades_canada)

#------------- TABLA DE FRECUENCIAS: VALORES VÁLIDOS DE Intersection.Directions -----------------# 

datos_filtrados <- datos %>% filter(Country %in% c("US", "CA") & !is.na(Intersection.Directions))

# Crear tabla de frecuencia con valores válidos
tabla_Intersection.Directions_validos <- datos_filtrados %>%
  filter(Intersection.Directions %in% valores_validos_Intersection.Directions) %>%
  count(Intersection.Directions, name = "Frecuencia") %>%
  arrange(desc(Frecuencia))

cat("\nCantidad de valores válidos de Intersection.Directions:", nrow(tabla_Intersection.Directions_validos), "\n")
cat("Valores válidos:\n")
print(tabla_Intersection.Directions_validos$Intersection.Directions)

# Valores sospechosos (para revisión)
cat("\nCantidad de valores sospechosos de Intersection.Directions:", length(valores_sospechosos_Intersection.Directions), "\n")
cat("Valores sospechosos:\n")
print(valores_sospechosos_Intersection.Directions)

#--------------- RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA DE Intersection.Directions --------------#

max_frecuencia_Intersection.Directions <- max(tabla_Intersection.Directions_validos$Frecuencia, na.rm = TRUE)
tabla_moda_Intersection.Directions <- tabla_Intersection.Directions_validos %>% filter(Frecuencia == max_frecuencia_Intersection.Directions)

cat("RESUMEN ESTADÍSTICO POR FRECUENCIA – MODA (Intersection.Directions):\n")
print(tabla_moda_Intersection.Directions)

#------------- TABLA INTERACTIVA MODA FORMATO PERSONALIZADO PARA Intersection.Directions ------------#

datatable(tabla_moda_Intersection.Directions,
          options = list(
            pageLength = 5,
            autoWidth = TRUE,
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "$(row).css({'font-weight': 'bold', 'background-color': '#f0f0f0'});",
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Direcciones de intersección", "Frecuencia"),
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla – Resumen Estadístico por Frecuencia (Moda de Indicaciones de Intersección de Estación de Carga)"
          )
)

#-------------- CREAR TABLA DE FRECUENCIA Y ORDENAR PARA Intersection.Directions ----------------------#

tabla_ordenada_Intersection.Directions <- tabla_Intersection.Directions_validos

#-------- AGRUPAR POR RANGOS DECILES DEFINIDOS – Intersection.Directions -----------------------#

tabla_ordenada_Intersection.Directions <- tabla_ordenada_Intersection.Directions %>%
  mutate(Grupo = case_when(
    Frecuencia >= 1     & Frecuencia <= 10     ~ "001 - 010",
    Frecuencia >= 11    & Frecuencia <= 20     ~ "011 - 020",
    Frecuencia >= 21    & Frecuencia <= 50     ~ "021 - 050",
    Frecuencia >= 51    & Frecuencia <= 70     ~ "051 - 070",
    Frecuencia >= 71    & Frecuencia <= 100    ~ "071 - 100",
    Frecuencia >= 101   & Frecuencia <= 200    ~ "101 - 200",
    Frecuencia >= 201   & Frecuencia <= 300    ~ "201 - 300",
    Frecuencia >= 301   & Frecuencia <= 400    ~ "301 - 400",
    Frecuencia >= 401   & Frecuencia <= 1000   ~ "401 - 1000",
    Frecuencia >= 1001  & Frecuencia <= 1586   ~ "1001 - 1586",
    TRUE ~ "Fuera de Rango"
  ))

#------------- AGRUPAR POR RANGO Y CALCULAR FRECUENCIA TOTAL – Intersection.Directions ----------------#

tabla_por_grupo_Intersection.Directions <- tabla_ordenada_Intersection.Directions %>%
  group_by(Grupo) %>%
  summarise(Total_Frecuencia = sum(Frecuencia), .groups = "drop") %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

#---------------- AGREGAR FILA DE TOTAL GENERAL – Intersection.Directions ---------------------------#

total_general_Intersection.Directions <- sum(tabla_por_grupo_Intersection.Directions$Total_Frecuencia, na.rm = TRUE)
fila_total_Intersection.Directions <- data.frame(Grupo = "TOTAL", Total_Frecuencia = total_general_Intersection.Directions)
tabla_por_grupo_Intersection.Directions_con_total <- bind_rows(tabla_por_grupo_Intersection.Directions, fila_total_Intersection.Directions)

#------------------ MOSTRAR TABLA RESULTANTE – Intersection.Directions -------------------------------#

print(tabla_por_grupo_Intersection.Directions_con_total)

#--------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA DIRECCIONES DE INTERSECCIÓN VS EST. CARGA -------------#

library(htmltools)

datatable(tabla_por_grupo_Intersection.Directions_con_total,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '100px', targets = 1)
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              
              "if(data[0] === 'TOTAL') {",
              "$(row).css({'font-weight': 'bold', 'background-color': '#e0e0e0'});",
              "} else if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f2f2f2');",
              "}",
              
              "$('td:eq(1)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla Nº25. Frecuencia Absoluta Direcciones de intersección"
          )
)

#-------------------- TABLA AGRUPADA INCLUYE RANGOS Y DIRECCIONES DE INTERSECCIÓN ---------------------#

tabla_ciudades_por_grupo <- tabla_ordenada_Intersection.Directions %>%
  filter(Grupo != "Fuera de Rango") %>%
  group_by(Grupo) %>%
  summarise(
    Ciudades = paste0(Intersection.Directions, " (", Frecuencia, ")", collapse = ", "),
    Total_Frecuencia = sum(Frecuencia),
    .groups = "drop"
  ) %>%
  arrange(factor(Grupo, levels = c(
    "001 - 010", "011 - 020", "021 - 050", "051 - 070", "071 - 100",
    "101 - 200", "201 - 300", "301 - 400", "401 - 1000", "1001 - 1586"
  )))

print(tabla_ciudades_por_grupo)

#------- TABLA INTERACTIVA FRECUENCIA ABSOLUTA DIRECCIONES DE INTERSECCIÓN VS EST. CARGA ---------------#

library(htmltools)

datatable(tabla_ciudades_por_grupo,
          options = list(
            pageLength = 10,
            autoWidth = TRUE,
            columnDefs = list(
              list(width = '150px', targets = 0),  # Rango
              list(width = '450px', targets = 1),  # DIRECCIONES DE INTERSECCIÓN 
              list(width = '130px', targets = 2)   # Total Frecuencia
            ),
            initComplete = JS(
              "function(settings, json) {",
              "$(this.api().table().header()).css({",
              "'background-color': 'darkblue',",
              "'color': 'white',",
              "'font-weight': 'bold',",
              "'font-family': 'Segoe UI'",
              "});",
              "}"
            ),
            rowCallback = JS(
              "function(row, data, index) {",
              "$(row).css('font-family', 'Segoe UI');",
              "if(index % 2 === 0) {",
              "$(row).css('background-color', 'white');",
              "} else {",
              "$(row).css('background-color', '#f9f9f9');",
              "}",
              "$('td:eq(2)', row).css({'text-align': 'right', 'padding-right': '10px'});",
              "}"
            ),
            dom = 't'
          ),
          rownames = FALSE,
          colnames = c("Rango de Frecuencia", "Direcciones de intersección(Frecuencia)", "Frecuencia Total"),
          caption = tags$caption(
            style = 'caption-side: top; text-align: center; font-weight: bold; padding: 10px; font-family: Segoe UI;',
            "Tabla: Direcciones de intersección agrupadas por rango de frecuencia con totales"
          )
)

#------------- GRÁFICA DE BARRAS - FRECUENCIA ABSOLUTA DIRECCIONES DE INTERSECCION---------------------#

library(ggplot2)
library(dplyr)

# Excluir fila TOTAL y asegurar tipo numérico
tabla_ciudades_por_grupo_grafico <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(Total_Frecuencia = as.numeric(Total_Frecuencia))

# Crear gráfico de barras para Intersection.Directions por rangos
ggplot(tabla_ciudades_por_grupo_grafico, aes(x = reorder(Grupo, -Total_Frecuencia), y = Total_Frecuencia, fill = Total_Frecuencia)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = Total_Frecuencia),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +  # Gama de colores conservada
  labs(
    title = "Gráfica Nº25.1 Frecuencia Absoluta de Estaciones de Carga por Rango de Indicaciones de Intersección (Intersection.Directions)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Total",
    fill = "Frecuencia Total"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA ABSOLUTA DIRECCIONES DE INTERSECCIÓN --------------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos para gráfica circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  ) %>%
  arrange(Total_Frecuencia)  # Para mantener orden de colores

# Reordenar factor Grupo según Total_Frecuencia ascendente
tabla_ciudades_por_grupo_circular$Grupo <- factor(
  tabla_ciudades_por_grupo_circular$Grupo,
  levels = tabla_ciudades_por_grupo_circular$Grupo
)

# Calcular posiciones para gráfico circular
tabla_ciudades_por_grupo_circular <- tabla_ciudades_por_grupo_circular %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta de colores skyblue → darkblue según orden ascendente
colores_por_grupo_circular <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_circular$Grupo))),
  levels(tabla_ciudades_por_grupo_circular$Grupo)
)

# Agregar color para etiquetas
tabla_ciudades_por_grupo_circular$color_etiqueta <- colores_por_grupo_circular[
  as.character(tabla_ciudades_por_grupo_circular$Grupo)
]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_circular, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas con color por grupo
  geom_label(
    aes(x = 2.5, y = pos, label = Total_Frecuencia),
    fill = NA,
    color = tabla_ciudades_por_grupo_circular$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores personalizada
  scale_fill_manual(values = colores_por_grupo_circular) +
  
  # Título y leyenda
  labs(
    title = "Gráfica Nº25.2 Distribución de la Frecuencia Absoluta de Estaciones de Carga por Rango de Indicaciones de Intersección (Intersection.Directions)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )

#----------- GRÁFICA DE BARRAS - FRECUENCIA RELATIVA DIRECCIONES DE INTERSECCIÓN -------------------#

library(ggplot2)
library(dplyr)
library(scales)  # para formatear porcentajes

# Preparar tabla para gráfico (sin fila TOTAL y con proporciones)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>% 
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    Frecuencia_Relativa = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Crear gráfico de barras para frecuencia relativa
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  x = reorder(Grupo, -Frecuencia_Relativa),
  y = Frecuencia_Relativa,
  fill = Frecuencia_Relativa
)) +
  geom_bar(stat = "identity", width = 0.9) +
  geom_text(
    aes(label = percent(Frecuencia_Relativa, accuracy = 0.1)),
    vjust = -0.5,
    size = 5,
    family = "Segoe UI",
    color = "black"
  ) +
  scale_fill_gradient(low = "skyblue", high = "darkblue") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Gráfica Nº25.3 Frecuencia Relativa (%) de Estaciones de Carga por Rango de Indicaciones de Intersección (Intersection.Directions)",
    x = "Rango de Frecuencia",
    y = "Frecuencia Relativa",
    fill = "Frecuencia Relativa"
  ) +
  theme_minimal(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    axis.text.y = element_text(size = 13),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    legend.position = c(0.88, 0.85),
    legend.title = element_text(face = "bold")
  )

#-------------- GRÁFICA CIRCULAR - FRECUENCIA RELATIVA POR DIRECCIONES DE INTERSECCIÓN -----------#

library(ggplot2)
library(dplyr)
library(scales)

# Preparar datos: eliminar TOTAL, convertir y calcular % relativa
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo %>%
  filter(Grupo != "TOTAL") %>%
  mutate(
    Total_Frecuencia = as.numeric(Total_Frecuencia),
    porcentaje = Total_Frecuencia / sum(Total_Frecuencia)
  )

# Ordenar por frecuencia ascendente (para asignar colores suaves a menores frecuencias)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(Total_Frecuencia)

# Reordenar factor de niveles para mantener colores ordenados
tabla_ciudades_por_grupo_relativa$Grupo <- factor(
  tabla_ciudades_por_grupo_relativa$Grupo,
  levels = tabla_ciudades_por_grupo_relativa$Grupo
)

# Calcular posiciones para el gráfico circular (orden descendente)
tabla_ciudades_por_grupo_relativa <- tabla_ciudades_por_grupo_relativa %>%
  arrange(desc(Total_Frecuencia)) %>%
  mutate(
    ymax = cumsum(porcentaje),
    ymin = lag(ymax, default = 0),
    pos = (ymax + ymin) / 2
  )

# Paleta personalizada de skyblue a darkblue
colores_por_grupo_relativa <- setNames(
  colorRampPalette(c("skyblue", "darkblue"))(length(levels(tabla_ciudades_por_grupo_relativa$Grupo))),
  levels(tabla_ciudades_por_grupo_relativa$Grupo)
)

# Etiquetas del mismo color que el grupo
tabla_ciudades_por_grupo_relativa$color_etiqueta <- colores_por_grupo_relativa[as.character(tabla_ciudades_por_grupo_relativa$Grupo)]

# Crear gráfico circular
ggplot(tabla_ciudades_por_grupo_relativa, aes(
  ymax = ymax, ymin = ymin,
  xmax = 2, xmin = 0,
  fill = Grupo
)) +
  geom_rect(color = "white") +
  coord_polar(theta = "y") +
  
  # Líneas guía
  geom_segment(aes(x = 2, xend = 2.2, y = pos, yend = pos), color = "gray30") +
  geom_segment(aes(x = 2.2, xend = 2.3, y = pos, yend = pos), color = "gray30") +
  
  # Etiquetas porcentuales
  geom_label(
    aes(x = 2.5, y = pos, label = percent(porcentaje, accuracy = 0.1)),
    fill = NA,
    color = tabla_ciudades_por_grupo_relativa$color_etiqueta,
    size = 5,
    family = "Segoe UI",
    label.size = 0.8
  ) +
  
  # Escala de colores manual
  scale_fill_manual(values = colores_por_grupo_relativa) +
  
  labs(
    title = "Gráfica Nº25.4 Distribución de la Frecuencia Relativa (%) de Estaciones de Carga por Rango de Indicaciones de Intersección (Intersection.Directions)",
    fill = "Grupo"
  ) +
  theme_void(base_family = "Segoe UI") +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    legend.position = c(1.1, 0.7),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  )
```
